## 날짜: 2024-07-05

### 스크럼
- 학습 목표 1 : 데이터베이스 스키마 변경시 무중단 배포 방법
- 학습 목표 2 : Mysql binlog, Postgresql pg_wal

### 새로 배운 내용
#### 주제 1: 데이터베이스 스키마 변경시 무중단 배포 방법
# 데이터베이스 스키마 변경 시 무중단 배포 방법

## 스키마 변경 종류

| 컬럼,테이블 삭제 |
| --- |
| 타입 변경 |
| 이름 변경 |
| 제약조건 추가/삭제 |
| 인덱스 추가/삭제 |

## 문제 발생

CREATE , ALTER , DROP , RENAME , TRUNCATE 등의 DDL(Data Definition Language)을 사용할 것입니다.

문제는 대부분의 DDL은 데이터의 일관성과 무결성을 보장하기 위해 쓰기 잠금을 발생시킵니다.

실행시간에 따라 서비스 중단을 유발할 수 있습니다.

## 무중단 배포 방법

### 온라인 DDL

온라인 DDL은 테이블 구조를 변경할 때 테이블에 대한 접근을 최소한으로 방해하면서 작업을 수행할 수 있게 합니다. 이는 무중단 배포를 가능하게 하고, 데이터베이스의 가용성을 유지하는 데 중요한 역할을 합니다.

**MySQL에서 온라인 DDL 사용**

MySQL InnoDB 엔진이 온라인 DDL 기능을 지원합니다.

- **ALGORITHM=INPLACE**: MySQL은 테이블 전체를 복사하지 않고 메타데이터와 인덱스만 변경하여 스키마 변경 작업을 수행합니다.
- **LOCK=NONE**: 변경 작업 동안 읽기와 쓰기 작업을 동시에 허용하여 서비스 중단을 방지합니다.

```sql
// 컬럼 추가
ALTER TABLE employees 
ADD COLUMN middle_name VARCHAR(50), ALGORITHM=INPLACE, LOCK=NONE;

// 외래키 추가
ALTER TABLE orders 
ADD CONSTRAINT fk_customer_id FOREIGN KEY (customer_id) 
REFERENCES customers (id), ALGORITHM=INPLACE, LOCK=NONE;

```

**온라인 DDL 주의사항**

온라인 DDL 작업은 여전히 I/O와 CPU 리소스를 사용하므로 성능에 영향을 미칠 수 있습니다. 대규모 테이블에서는 신중한 모니터링이 필요합니다.

작업중 롤백이 발생할 수 있으며, 롤백시 많은 비용이 소모됩니다.

### pt-online-schema-change

MySQL 테이블의 스키마 변경을 무중단으로 수행할 수 있게 해주는 Percona Toolkit중 하나입니다.

`pt-online-schema-change`는 다음과 같은 단계로 작동합니다:

1. **테이블 복사**: 원본 테이블을 복사하여 새로운 테이블을 생성합니다. 새로운 테이블에는 필요한 스키마 변경을 적용합니다.
2. **트리거 생성**: 원본 테이블에 트리거를 생성하여 데이터 변경 사항을 새로운 테이블에 동기화합니다. 이 트리거는 원본 테이블에서 발생하는 INSERT, UPDATE, DELETE 작업을 새로운 테이블로 복사합니다.
3. **데이터 복사**: 원본 테이블의 데이터를 새로운 테이블로 복사합니다. 이 과정은 배치 작업으로 수행되어 성능에 미치는 영향을 최소화합니다.
4. **테이블 스왑**: 데이터 복사가 완료되면 원본 테이블과 새로운 테이블을 스왑합니다. 이 과정은 매우 짧은 시간 동안 잠금이 발생합니다.
5. **트리거 제거**: 트리거를 제거하여 작업을 완료합니다.

**주요 기능**

- **알고리즘 선택**: `pt-online-schema-change`는 다양한 복사 알고리즘을 제공하여 성능과 안정성을 최적화할 수 있습니다.
- **데이터 일관성**: 트리거를 사용하여 데이터 일관성을 유지합니다.
- **자동 중단**: 성능 문제가 발생하면 작업을 자동으로 중단합니다.
- **안전 검사**: 작업 전에 여러 안전 검사를 수행하여 잠재적인 문제를 미리 탐지합니다.

### gh-ost (GitHub Online Schema Transfomer)

`gh-ost`는 GitHub에서 개발한 MySQL용 무중단 스키마 변경 도구입니다. `gh-ost`는 기존의 `pt-online-schema-change` 도구와 유사하지만, 여러 추가 기능과 개선된 기능을 제공합니다. 

**추가 및 개선된 기능**

- **바이너리 로그 활용 방식**:
    
    MySQL 바이너리 로그를 사용하여 데이터 변경 사항을 실시간으로 동기화
    
- **작업 중단 및 재시작**:
    
    작업을 안전하게 중단하고 나중에 재시작 가능.
    
- **테이블 스왑 방식**:
    
    원본 테이블과 새 테이블을 스왑하며, 중간 테이블 유지.
    
- **성능 및 부하 관리**:
    
    자동으로 부하를 모니터링하고 작업 속도를 조정.

#### 주제 2: Mysql binlog, Postgresql pg_wal
# MySQL binlog 를 이용해서 할 수 있는 작업

### 1. **데이터 복제 (Replication)**

바이너리 로그는 복제 설정의 핵심 요소로, 마스터 서버에서 발생한 모든 데이터 변경 이벤트를 기록하고, 슬레이브 서버는 이 로그를 읽어 동일한 변경을 적용합니다.

### 2. 포인트 인 타임 복구 (PITR, Point-In-Time Recovery)

백업 파일과 바이너리 로그를 조합하여 데이터베이스를 특정 시점으로 복원할 수 있습니다.

### 3. **데이터베이스 감사 및 모니터링**

바이너리 로그를 분석하여 데이터베이스에서 발생한 모든 데이터 변경 이벤트를 추적할 수 있습니다.

### 4. **데이터 마이그레이션 및 복제**

바이너리 로그를 사용하여 데이터베이스 간의 데이터 마이그레이션을 수행할 수 있습니다.

### 5. **실시간 데이터 스트리밍**

바이너리 로그를 사용하여 실시간 데이터 스트리밍을 구현할 수 있습니다.

### 6. gh-ost 및 pt-online-schema-change와 같은 도구 지원

### 7. **데이터 복구 및 분석**

바이너리 로그는 데이터 복구 및 분석 목적으로 사용할 수 있습니다.

**로그 확인하기**

```bash
mysql -u root -p -e "SHOW BINARY LOGS;"
mysqlbinlog binlog.000011 > binlog_000011.txt // 바이너리형식 -> 텍스트형식
vim binlog_000011.txt
```

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/38552da6-340d-42c1-a9a1-b181ff331f03/3f179921-10d2-43be-b17e-033394af1d11/Untitled.png)

# Postgresql pg_wal 을 이용해서 할 수 있는 것

### 1. **데이터베이스 복구**

데이터베이스 크래시 이후, WAL 로그를 사용하여 마지막 체크포인트 이후의 모든 변경 사항을 재생(replay)하여 데이터베이스를 복구할 수 있습니다.

### 2. **포인트 인 타임 복구 (PITR, Point-In-Time Recovery)**

PITR은 특정 시점으로 데이터베이스를 복원하는 기능을 제공합니다.

### 3. **스트리밍 복제**

마스터 서버의 WAL 파일을 실시간으로 복제 서버로 전송하여 데이터를 동기화합니다.

### 4. **아카이브 및 백업**

WAL 아카이브를 통해 데이터베이스의 모든 변경 사항을 캡처하고, 필요 시 복구할 수 있습니다.

### 5. **데이터베이스 클러스터링 및 로드 밸런싱**

여러 데이터베이스 인스턴스를 동기화하는 데 사용됩니다.

### 오늘의 회고
- 데이터베이스 스키마 변경할때 무중단으로 배포할 수 있는 방법에 대해 알아보았습니다.
- binlog와 pg_wal이 어떻게 쓰이는지 알아보았습니다.
